{% extends "base.html" %}

{% block title %}{{ photo.original_name }} — Gallery{% endblock %}

{% block header_controls %}
<!-- No search/selection on photo page -->
{% endblock %}

{% block content %}
<div class="photo-view">
    <!-- Navigation arrows -->
    {% if prev_id %}
    <a href="{% if prev_type == 'album' %}/album/{{ prev_id }}{% else %}/photo/{{ prev_id }}{% endif %}" class="nav-arrow nav-prev" title="Previous (←)">
        <span>‹</span>
    </a>
    {% endif %}
    {% if next_id %}
    <a href="{% if next_type == 'album' %}/album/{{ next_id }}{% else %}/photo/{{ next_id }}{% endif %}" class="nav-arrow nav-next" title="Next (→)">
        <span>›</span>
    </a>
    {% endif %}

    <div class="photo-container">
        {% if media_type == 'video' %}
        <video src="/uploads/{{ photo.filename }}"
               id="main-video"
               class="main-video"
               controls
               autoplay
               loop
               playsinline>
            Your browser does not support the video tag.
        </video>
        {% else %}
        <img src="/uploads/{{ photo.filename }}"
             alt="{{ photo.original_name }}"
             id="main-photo"
             class="zoomable"
             title="Click to zoom">
        {% endif %}

        {% if album_info %}
        <!-- Album position indicator -->
        <div class="album-indicator">
            <div class="album-indicator-bars">
                {% for i in range(album_info.total) %}
                <div class="album-bar {% if i + 1 == album_info.current %}active{% endif %}"
                     data-photo-id="{{ album_info.photo_ids[i] }}"></div>
                {% endfor %}
            </div>
            <div class="album-indicator-text">
                {{ album_info.current }} / {{ album_info.total }}
            </div>
        </div>
        {% endif %}
    </div>

    <div class="photo-info">

        <div class="tags-section">
            <h3>Tags</h3>
            <div class="tags" id="tags-container">
                {% for tag in tags %}
                <span class="tag" style="--tag-color: {{ tag.color }}">{{ tag.tag }}</span>
                {% endfor %}
            </div>
            <p class="no-tags" id="no-tags-message" {% if tags %}style="display: none;"{% endif %}>
                No tags assigned
            </p>

            <div class="tag-actions">
                <button id="request-ai" class="btn btn-secondary">
                    Request AI Analysis
                </button>
                <button id="edit-tags-btn" class="btn btn-secondary">
                    Edit Tags
                </button>
            </div>
        </div>

        <div class="photo-actions">
            <button onclick="goBack()" class="btn btn-secondary">← Back</button>
            <a href="/uploads/{{ photo.filename }}"
               download="{{ photo.original_name }}"
               class="btn">Download</a>
        </div>

        <div class="keyboard-hints">
            <span>← → Navigate</span>
            <span>Esc Back</span>
        </div>
    </div>
</div>

{% if media_type != 'video' %}
<!-- Zoom overlay -->
<div id="zoom-overlay" class="zoom-overlay hidden">
    <button class="zoom-close" title="Close (Esc)">&times;</button>
    <div class="zoom-container">
        <img id="zoom-image" src="" alt="">
    </div>
    {% if prev_id %}
    <a href="{% if prev_type == 'album' %}/album/{{ prev_id }}{% else %}/photo/{{ prev_id }}{% endif %}" class="zoom-nav zoom-prev" title="Previous (←)">‹</a>
    {% endif %}
    {% if next_id %}
    <a href="{% if next_type == 'album' %}/album/{{ next_id }}{% else %}/photo/{{ next_id }}{% endif %}" class="zoom-nav zoom-next" title="Next (→)">›</a>
    {% endif %}

    {% if album_info %}
    <!-- Album indicator in zoom mode -->
    <div class="zoom-album-indicator">
        <div class="album-indicator-bars">
            {% for i in range(album_info.total) %}
            <div class="album-bar {% if i + 1 == album_info.current %}active{% endif %}"
                 data-photo-id="{{ album_info.photo_ids[i] }}"></div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>
{% endif %}

<!-- Tag Editor Modal -->
<div id="tag-editor-modal" class="modal hidden">
    <div class="modal-content tag-picker-content">
        <span class="close" id="close-tag-editor">&times;</span>
        <h2>Edit Tags</h2>

        <!-- Current tags -->
        <div id="current-tags-section" class="current-tags-section">
            <label>Selected:</label>
            <div id="current-tags-container" class="selected-tags-container">
                <span class="no-tags-hint">No tags selected</span>
            </div>
        </div>

        <div class="tag-search-container">
            <input type="text" id="tag-search" placeholder="Search or add new tag..." autocomplete="off">
        </div>

        <div id="tag-presets-container" class="tag-presets">
            <!-- Categories and tags will be loaded here -->
        </div>

        <div id="add-new-tag-section" class="add-new-tag-section hidden">
            <p>Tag "<span id="new-tag-name"></span>" not found</p>
            <div class="category-select">
                <label>Select category:</label>
                <div id="category-buttons" class="category-buttons">
                    <!-- Category buttons will be loaded here -->
                </div>
            </div>
            <button id="add-new-tag-btn" class="btn btn-small" disabled>Add to Library</button>
        </div>

        <!-- Save button -->
        <div class="tag-picker-actions">
            <button id="cancel-tags-btn" class="btn btn-secondary">Cancel</button>
            <button id="save-tags-btn" class="btn">Save Changes</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const photoId = "{{ photo.id }}";
    const albumInfo = {{ album_info|tojson if album_info else 'null' }};
    const mediaType = {{ media_type|tojson }};
    let categories = [];
    let selectedCategoryId = null;
    let editingTags = [];
    let isZoomed = false;
    let isModalOpen = false;

    // Server-provided fallback navigation
    let prevId = {{ prev_id|tojson }};
    let nextId = {{ next_id|tojson }};
    let prevType = {{ prev_type|tojson }};
    let nextType = {{ next_type|tojson }};

    // Override with visual order from gallery if available
    (function() {
        const navOrderJson = sessionStorage.getItem('galleryNavOrder');
        if (navOrderJson) {
            try {
                const navOrder = JSON.parse(navOrderJson);
                const currentIndex = navOrder.findIndex(item =>
                    (item.type === 'photo' && item.id === photoId) ||
                    (item.type === 'album' && item.id === photoId)
                );

                if (currentIndex !== -1) {
                    // Previous item
                    if (currentIndex > 0) {
                        const prev = navOrder[currentIndex - 1];
                        prevId = prev.id;
                        prevType = prev.type;
                    } else {
                        prevId = null;
                    }

                    // Next item
                    if (currentIndex < navOrder.length - 1) {
                        const next = navOrder[currentIndex + 1];
                        nextId = next.id;
                        nextType = next.type;
                    } else {
                        nextId = null;
                    }

                    // Update arrow links in DOM
                    updateNavArrows();
                }
            } catch (e) {
                console.error('Failed to parse nav order:', e);
            }
        }
    })();

    function updateNavArrows() {
        // Update main nav arrows
        document.querySelectorAll('.nav-prev, .zoom-prev').forEach(arrow => {
            if (prevId) {
                arrow.href = prevType === 'album' ? `/album/${prevId}` : `/photo/${prevId}`;
                arrow.style.display = '';
            } else {
                arrow.style.display = 'none';
            }
        });

        document.querySelectorAll('.nav-next, .zoom-next').forEach(arrow => {
            if (nextId) {
                arrow.href = nextType === 'album' ? `/album/${nextId}` : `/photo/${nextId}`;
                arrow.style.display = '';
            } else {
                arrow.style.display = 'none';
            }
        });
    }

    const originalTags = [
        {% for tag in tags %}
        { id: {{ tag.id }}, name: "{{ tag.tag }}", category_id: {{ tag.category_id or 'null' }}, color: "{{ tag.color }}" },
        {% endfor %}
    ];

    // Navigate to item (photo or album)
    function navigateTo(id, type) {
        if (type === 'album') {
            window.location.href = `/album/${id}`;
        } else {
            window.location.href = `/photo/${id}`;
        }
    }

    // Go back to gallery (with saved search query)
    function goBack() {
        const savedQuery = sessionStorage.getItem('gallerySearchQuery');
        if (savedQuery) {
            window.location.href = '/?q=' + encodeURIComponent(savedQuery);
        } else {
            window.location.href = '/';
        }
    }

    // ============ Keyboard Navigation ============
    document.addEventListener('keydown', (e) => {
        // Don't navigate if typing in input or modal is open
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
        if (isModalOpen && !isZoomed) return;

        switch (e.key) {
            case 'ArrowLeft':
                if (prevId) navigateTo(prevId, prevType);
                break;
            case 'ArrowRight':
                if (nextId) navigateTo(nextId, nextType);
                break;
            case 'Escape':
                if (isZoomed) {
                    closeZoom();
                } else {
                    goBack();
                }
                break;
        }
    });

    // ============ Album Bar Navigation ============
    document.querySelectorAll('.album-bar').forEach(bar => {
        bar.addEventListener('click', () => {
            const targetId = bar.dataset.photoId;
            if (targetId && targetId !== photoId) {
                window.location.href = `/photo/${targetId}`;
            }
        });
    });

    // ============ Zoom Functionality (only for images) ============
    if (mediaType !== 'video') {
        const zoomOverlay = document.getElementById('zoom-overlay');
        const zoomImage = document.getElementById('zoom-image');
        const mainPhoto = document.getElementById('main-photo');

        if (mainPhoto) {
            mainPhoto.onclick = () => {
                zoomImage.src = mainPhoto.src;
                zoomOverlay.classList.remove('hidden');
                isZoomed = true;
                document.body.style.overflow = 'hidden';
            };
        }

        function closeZoom() {
            zoomOverlay.classList.add('hidden');
            isZoomed = false;
            document.body.style.overflow = '';
        }

        document.querySelector('.zoom-close').onclick = closeZoom;
        zoomOverlay.onclick = (e) => {
            if (e.target === zoomOverlay || e.target.classList.contains('zoom-container')) {
                closeZoom();
            }
        };
    }

    function closeZoom() {
        if (mediaType !== 'video') {
            const zoomOverlay = document.getElementById('zoom-overlay');
            if (zoomOverlay) {
                zoomOverlay.classList.add('hidden');
                isZoomed = false;
                document.body.style.overflow = '';
            }
        }
    }

    // ============ Tag Editor ============
    async function loadTagPresets(search = "") {
        const response = await fetch(`/api/tag-presets?search=${encodeURIComponent(search)}`);
        const data = await response.json();
        renderPresets(data);
        return data;
    }

    async function loadCategories() {
        const response = await fetch('/api/tag-categories');
        categories = await response.json();
        renderCategoryButtons();
    }

    function renderPresets(presetsData) {
        const container = document.getElementById('tag-presets-container');
        if (presetsData.length === 0) {
            container.innerHTML = '<p class="no-presets">No matching tags found</p>';
            return;
        }

        container.innerHTML = presetsData.map(category => `
            <div class="preset-category">
                <h4 style="--cat-color: ${category.color}">${category.name}</h4>
                <div class="preset-tags">
                    ${category.tags.map(tag => {
                        const isSelected = editingTags.some(t => t.name.toLowerCase() === tag.name.toLowerCase());
                        return `
                            <button class="preset-tag ${isSelected ? 'selected' : ''}"
                                    style="--tag-color: ${category.color}"
                                    data-tag-name="${tag.name}"
                                    data-category-id="${category.id}"
                                    data-color="${category.color}"
                                    onclick="toggleTag('${tag.name}', ${category.id}, '${category.color}')">
                                ${tag.name}
                            </button>
                        `;
                    }).join('')}
                </div>
            </div>
        `).join('');
    }

    function renderCategoryButtons() {
        const container = document.getElementById('category-buttons');
        container.innerHTML = categories.map(cat => `
            <button class="category-btn" style="--cat-color: ${cat.color}"
                    data-category-id="${cat.id}"
                    onclick="selectCategory(${cat.id})">
                ${cat.name}
            </button>
        `).join('');
    }

    function selectCategory(categoryId) {
        selectedCategoryId = categoryId;
        document.querySelectorAll('.category-btn').forEach(btn => {
            btn.classList.toggle('selected', btn.dataset.categoryId == categoryId);
        });
        document.getElementById('add-new-tag-btn').disabled = false;
    }

    function toggleTag(tagName, categoryId, color) {
        const index = editingTags.findIndex(t => t.name.toLowerCase() === tagName.toLowerCase());

        if (index === -1) {
            editingTags.push({ name: tagName, category_id: categoryId, color: color });
        } else {
            editingTags.splice(index, 1);
        }

        updateCurrentTagsDisplay();
        updatePresetButtons();
    }

    function removeTagFromEditing(tagName) {
        const index = editingTags.findIndex(t => t.name.toLowerCase() === tagName.toLowerCase());
        if (index !== -1) {
            editingTags.splice(index, 1);
            updateCurrentTagsDisplay();
            updatePresetButtons();
        }
    }

    function updateCurrentTagsDisplay() {
        const container = document.getElementById('current-tags-container');

        if (editingTags.length === 0) {
            container.innerHTML = '<span class="no-tags-hint">No tags selected</span>';
        } else {
            container.innerHTML = editingTags.map(tag => `
                <span class="selected-tag" style="--tag-color: ${tag.color}">
                    ${tag.name}
                    <button class="tag-remove" onclick="removeTagFromEditing('${tag.name}')">&times;</button>
                </span>
            `).join('');
        }
    }

    function updatePresetButtons() {
        document.querySelectorAll('.preset-tag').forEach(btn => {
            const tagName = btn.dataset.tagName;
            const isSelected = editingTags.some(t => t.name.toLowerCase() === tagName.toLowerCase());
            btn.classList.toggle('selected', isSelected);
        });
    }

    async function saveTagChanges() {
        const saveBtn = document.getElementById('save-tags-btn');
        saveBtn.disabled = true;
        saveBtn.textContent = 'Saving...';

        const toAdd = editingTags.filter(et =>
            !originalTags.some(ot => ot.name.toLowerCase() === et.name.toLowerCase())
        );

        const toRemove = originalTags.filter(ot =>
            !editingTags.some(et => et.name.toLowerCase() === ot.name.toLowerCase())
        );

        for (const tag of toRemove) {
            await fetch(`/api/photos/${photoId}/tag/${tag.id}`, { method: 'DELETE' });
        }

        for (const tag of toAdd) {
            await fetch(`/api/photos/${photoId}/tag`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ tag: tag.name, category_id: tag.category_id })
            });
        }

        location.reload();
    }

    // Tag editor modal
    const tagEditorModal = document.getElementById('tag-editor-modal');
    const editTagsBtn = document.getElementById('edit-tags-btn');
    const closeTagEditorBtn = document.getElementById('close-tag-editor');
    const cancelTagsBtn = document.getElementById('cancel-tags-btn');
    const saveTagsBtn = document.getElementById('save-tags-btn');
    const tagSearch = document.getElementById('tag-search');
    const addNewTagSection = document.getElementById('add-new-tag-section');

    editTagsBtn.onclick = async () => {
        editingTags = originalTags.map(t => ({ ...t }));
        updateCurrentTagsDisplay();

        tagEditorModal.classList.remove('hidden');
        isModalOpen = true;
        await loadCategories();
        await loadTagPresets();
        tagSearch.value = '';
        tagSearch.focus();
        addNewTagSection.classList.add('hidden');
    };

    function closeTagEditor() {
        tagEditorModal.classList.add('hidden');
        isModalOpen = false;
        selectedCategoryId = null;
        editingTags = [];
    }

    closeTagEditorBtn.onclick = closeTagEditor;
    cancelTagsBtn.onclick = closeTagEditor;
    tagEditorModal.onclick = (e) => {
        if (e.target === tagEditorModal) closeTagEditor();
    };

    saveTagsBtn.onclick = saveTagChanges;

    // Search functionality
    let searchTimeout;
    tagSearch.oninput = () => {
        clearTimeout(searchTimeout);
        const query = tagSearch.value.trim();

        searchTimeout = setTimeout(async () => {
            const presets = await loadTagPresets(query);

            if (query.length > 0) {
                const hasExactMatch = presets.some(cat =>
                    cat.tags.some(t => t.name.toLowerCase() === query.toLowerCase())
                );

                if (!hasExactMatch) {
                    document.getElementById('new-tag-name').textContent = query;
                    addNewTagSection.classList.remove('hidden');
                    selectedCategoryId = null;
                    document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('selected'));
                    document.getElementById('add-new-tag-btn').disabled = true;
                } else {
                    addNewTagSection.classList.add('hidden');
                }
            } else {
                addNewTagSection.classList.add('hidden');
            }
        }, 300);
    };

    // Add new tag to library and selection
    document.getElementById('add-new-tag-btn').onclick = async () => {
        const tagName = tagSearch.value.trim();
        if (!tagName || !selectedCategoryId) return;

        if (editingTags.some(t => t.name.toLowerCase() === tagName.toLowerCase())) {
            alert('This tag is already selected');
            return;
        }

        await fetch('/api/tag-presets', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name: tagName, category_id: selectedCategoryId })
        });

        const category = categories.find(c => c.id === selectedCategoryId);
        editingTags.push({
            name: tagName.toLowerCase(),
            category_id: selectedCategoryId,
            color: category?.color || '#6b7280'
        });

        updateCurrentTagsDisplay();
        tagSearch.value = '';
        addNewTagSection.classList.add('hidden');
        await loadTagPresets();
    };

    // AI Analysis button
    document.getElementById('request-ai').onclick = async () => {
        const btn = document.getElementById('request-ai');
        btn.disabled = true;
        btn.textContent = 'Analyzing...';

        try {
            const response = await fetch(`/api/photos/${photoId}/ai-tags`, {
                method: 'POST'
            });
            const data = await response.json();

            if (data.status === 'ok') {
                location.reload();
            } else {
                btn.textContent = 'Error occurred';
                btn.disabled = false;
            }
        } catch (err) {
            btn.textContent = 'Error occurred';
            btn.disabled = false;
        }
    };
</script>
{% endblock %}
