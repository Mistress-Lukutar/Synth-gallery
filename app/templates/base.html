<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Synth{% endblock %}</title>
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <header>
        <nav>
            <a href="/" class="logo"><img src="/static/favicon.svg" alt="" class="logo-icon">Synth</a>

            {% block header_controls %}
            <!-- Tag Search -->
            <div class="search-container">
                <input type="text" id="tag-search-input" placeholder="Search by tags..." autocomplete="off">
                <div id="tag-suggestions" class="suggestions hidden"></div>
            </div>

            <!-- Selection Menu (hidden by default) -->
            <div id="selection-menu" class="selection-menu hidden">
                <span id="selection-count">0 selected</span>
                <button id="select-all-btn" class="btn btn-small btn-secondary">Select All</button>
                <button id="deselect-all-btn" class="btn btn-small btn-secondary">Deselect</button>
                <button id="ai-selected-btn" class="btn btn-small">AI Tags</button>
                <button id="delete-selected-btn" class="btn btn-small btn-danger">Delete</button>
            </div>
            {% endblock %}

            <button id="upload-btn" class="btn">Upload</button>

            {% if user %}
            <div class="user-menu">
                <span class="user-name">{{ user.display_name }}</span>
                <a href="/logout" class="btn btn-secondary btn-small">Logout</a>
            </div>
            {% endif %}
        </nav>
    </header>

    <main>
        {% block content %}{% endblock %}
    </main>

    <!-- Upload modal -->
    <div id="upload-modal" class="modal hidden">
        <div class="modal-content upload-modal-content">
            <span class="close">&times;</span>
            <h2>Upload Media</h2>

            <div id="drop-zone" class="drop-zone">
                <input type="file" id="file-input" accept="image/*,video/mp4,video/webm" multiple>
                <div class="drop-zone-text">
                    <span class="drop-icon">+</span>
                    <p>Drag & drop images or videos here</p>
                    <p class="drop-hint">or click to select files (jpg, png, gif, webp, mp4, webm)</p>
                </div>
            </div>

            <div id="upload-preview-container" class="upload-preview-container hidden">
                <div class="preview-header">
                    <span id="preview-count">0 files selected</span>
                    <button type="button" id="clear-files-btn" class="btn btn-small btn-secondary">Clear</button>
                </div>
                <div id="upload-preview" class="upload-preview"></div>
            </div>

            <div id="upload-options" class="upload-options hidden">
                <div class="upload-option">
                    <label class="checkbox-label">
                        <input type="checkbox" id="upload-as-album">
                        <span class="checkmark"></span>
                        Upload as album
                    </label>
                </div>

                <div class="upload-option">
                    <label class="checkbox-label">
                        <input type="checkbox" id="auto-ai-tags">
                        <span class="checkmark"></span>
                        Auto-generate AI tags
                    </label>
                </div>

                <div id="manual-tags-section" class="manual-tags-section">
                    <label>Add tags:</label>
                    <input type="text" id="upload-tags-input" placeholder="tag1, tag2, tag3..." autocomplete="off">
                    <p class="input-hint">Comma-separated tags to apply to all photos</p>
                </div>
            </div>

            <div id="upload-progress" class="upload-progress hidden">
                <div class="progress-bar"><div id="progress-fill" class="progress-fill"></div></div>
                <span id="progress-text" class="progress-text">Uploading...</span>
            </div>

            <div id="upload-actions" class="upload-actions">
                <button type="button" id="cancel-upload-btn" class="btn btn-secondary">Cancel</button>
                <button type="button" id="submit-upload-btn" class="btn" disabled>Upload</button>
            </div>
        </div>
    </div>

    <script>
        // Upload modal elements
        const modal = document.getElementById('upload-modal');
        const uploadBtn = document.getElementById('upload-btn');
        const closeBtn = modal.querySelector('.close');
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const previewContainer = document.getElementById('upload-preview-container');
        const preview = document.getElementById('upload-preview');
        const previewCount = document.getElementById('preview-count');
        const clearFilesBtn = document.getElementById('clear-files-btn');
        const uploadOptions = document.getElementById('upload-options');
        const albumCheckbox = document.getElementById('upload-as-album');
        const autoAiTagsCheckbox = document.getElementById('auto-ai-tags');
        const tagsInput = document.getElementById('upload-tags-input');
        const progressDiv = document.getElementById('upload-progress');
        const progressFill = document.getElementById('progress-fill');
        const progressText = document.getElementById('progress-text');
        const cancelBtn = document.getElementById('cancel-upload-btn');
        const submitBtn = document.getElementById('submit-upload-btn');

        let isUploading = false;

        // Open/close modal
        uploadBtn.onclick = () => modal.classList.remove('hidden');
        closeBtn.onclick = () => closeModal();
        cancelBtn.onclick = () => closeModal();
        modal.onclick = (e) => {
            if (e.target === modal && !isUploading) closeModal();
        };

        function closeModal() {
            if (isUploading) return;
            modal.classList.add('hidden');
            resetUploadForm();
        }

        function resetUploadForm() {
            fileInput.value = '';
            preview.innerHTML = '';
            previewContainer.classList.add('hidden');
            uploadOptions.classList.add('hidden');
            progressDiv.classList.add('hidden');
            albumCheckbox.checked = false;
            autoAiTagsCheckbox.checked = false;
            tagsInput.value = '';
            submitBtn.disabled = true;
            progressFill.style.width = '0%';
        }

        // Check if file is valid media (image or video)
        function isValidMedia(file) {
            return file.type.startsWith('image/') ||
                   file.type === 'video/mp4' ||
                   file.type === 'video/webm';
        }

        // Update preview when files selected
        function updatePreview(files) {
            const mediaFiles = Array.from(files).filter(isValidMedia);

            if (mediaFiles.length === 0) {
                previewContainer.classList.add('hidden');
                uploadOptions.classList.add('hidden');
                submitBtn.disabled = true;
                return;
            }

            preview.innerHTML = '';
            for (const file of mediaFiles) {
                if (file.type.startsWith('video/')) {
                    // Create video thumbnail preview
                    const video = document.createElement('video');
                    video.src = URL.createObjectURL(file);
                    video.className = 'preview-thumb';
                    video.title = file.name;
                    video.muted = true;
                    video.preload = 'metadata';
                    preview.appendChild(video);
                } else {
                    const img = document.createElement('img');
                    img.src = URL.createObjectURL(file);
                    img.className = 'preview-thumb';
                    img.title = file.name;
                    preview.appendChild(img);
                }
            }

            previewCount.textContent = `${mediaFiles.length} file${mediaFiles.length > 1 ? 's' : ''} selected`;
            previewContainer.classList.remove('hidden');
            uploadOptions.classList.remove('hidden');
            submitBtn.disabled = false;

            // Show album option only for multiple files
            const albumOption = albumCheckbox.closest('.upload-option');
            if (mediaFiles.length > 1) {
                albumOption.style.display = '';
            } else {
                albumOption.style.display = 'none';
                albumCheckbox.checked = false;
            }
        }

        fileInput.onchange = () => updatePreview(fileInput.files);
        clearFilesBtn.onclick = () => {
            fileInput.value = '';
            updatePreview([]);
        };

        // Drag & drop for drop zone in modal
        dropZone.ondragover = (e) => {
            e.preventDefault();
            dropZone.classList.add('drag-over');
        };
        dropZone.ondragleave = () => dropZone.classList.remove('drag-over');
        dropZone.ondrop = (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
            const dt = new DataTransfer();
            for (const file of e.dataTransfer.files) {
                if (isValidMedia(file)) {
                    dt.items.add(file);
                }
            }
            fileInput.files = dt.files;
            updatePreview(dt.files);
        };

        // File upload
        submitBtn.onclick = async () => {
            const files = Array.from(fileInput.files).filter(isValidMedia);
            if (!files.length) return;

            isUploading = true;
            submitBtn.disabled = true;
            cancelBtn.disabled = true;
            progressDiv.classList.remove('hidden');

            const isAlbum = albumCheckbox.checked && files.length > 1;
            const useAiTags = autoAiTagsCheckbox.checked;
            const manualTags = tagsInput.value.trim()
                .split(',')
                .map(t => t.trim().toLowerCase())
                .filter(t => t.length > 0);

            let uploadedIds = [];

            try {
                if (isAlbum) {
                    progressText.textContent = 'Uploading album...';
                    progressFill.style.width = '50%';

                    const formData = new FormData();
                    for (const file of files) {
                        formData.append('files', file);
                    }
                    const resp = await fetch('/upload-album', { method: 'POST', body: formData });
                    const data = await resp.json();
                    uploadedIds = data.photos.map(p => p.id);
                    progressFill.style.width = '100%';
                } else {
                    for (let i = 0; i < files.length; i++) {
                        progressText.textContent = `Uploading ${i + 1}/${files.length}...`;
                        progressFill.style.width = `${((i + 1) / files.length) * 100}%`;

                        const formData = new FormData();
                        formData.append('file', files[i]);
                        const resp = await fetch('/upload', { method: 'POST', body: formData });
                        const data = await resp.json();
                        uploadedIds.push(data.id);
                    }
                }

                // Apply AI tags if requested
                if (useAiTags && uploadedIds.length > 0) {
                    progressText.textContent = 'Generating AI tags...';
                    await fetch('/api/photos/batch-ai-tags', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ photo_ids: uploadedIds })
                    });
                }

                // Apply manual tags if provided
                if (manualTags.length > 0 && uploadedIds.length > 0) {
                    progressText.textContent = 'Applying tags...';
                    for (const photoId of uploadedIds) {
                        for (const tag of manualTags) {
                            await fetch(`/api/photos/${photoId}/tag`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ tag: tag, category_id: 6 })
                            });
                        }
                    }
                }

                progressText.textContent = 'Done!';
                setTimeout(() => location.reload(), 500);

            } catch (err) {
                console.error('Upload error:', err);
                progressText.textContent = 'Upload failed!';
                isUploading = false;
                submitBtn.disabled = false;
                cancelBtn.disabled = false;
            }
        };
    </script>

    {% block scripts %}{% endblock %}
</body>
</html>
