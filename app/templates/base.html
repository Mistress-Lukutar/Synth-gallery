<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ request.state.csrf_token }}">
    <title>{% block title %}Synth{% endblock %}</title>
    <link rel="icon" type="image/svg+xml" href="{{ base_url }}/static/favicon.svg">
    <link rel="stylesheet" href="{{ base_url }}/static/style.css">
    
    <!-- Global config -->
    <script>
        window.SYNTH_BASE_URL = '{{ base_url }}';
        {% if user %}
        window.SYNTH_USER_ID = {{ user.id }};
        {% endif %}
    </script>
    
    <!-- Core utilities -->
    <script src="{{ base_url }}/static/js/core.js"></script>
    <!-- Back Button Manager (must be loaded before modals) -->
    <script src="{{ base_url }}/static/js/back-button.js"></script>
    <!-- Folder Actions -->
    <script src="{{ base_url }}/static/js/folder-actions.js"></script>
    <!-- Navigation -->
    <script src="{{ base_url }}/static/js/navigation.js"></script>
    <!-- Sidebar -->
    <script src="{{ base_url }}/static/js/sidebar.js"></script>
    <!-- Upload -->
    <script src="{{ base_url }}/static/js/upload.js"></script>
    <!-- Gallery modules (load after DOM) -->
    <script src="{{ base_url }}/static/js/gallery-masonry.js"></script>
    <script src="{{ base_url }}/static/js/gallery-selection.js"></script>
    <script src="{{ base_url }}/static/js/gallery-lightbox.js"></script>
    <script src="{{ base_url }}/static/js/gallery-tags.js"></script>
    <script src="{{ base_url }}/static/js/gallery-search.js"></script>
    <script src="{{ base_url }}/static/js/gallery-dragdrop.js"></script>
    <script src="{{ base_url }}/static/js/gallery-albums.js"></script>
    <!-- Safes -->
    <script src="{{ base_url }}/static/js/safes.js"></script>
    <!-- Initialization (last) -->
    <script src="{{ base_url }}/static/js/init.js"></script>
</head>
<body>
    <div class="app-layout">
        <!-- Sidebar -->
        <aside id="sidebar" class="sidebar">
            <div class="sidebar-logo">
                <a href="{{ base_url }}/" class="logo" onclick="event.preventDefault(); navigateToDefaultFolder();"><img src="{{ base_url }}/static/favicon.svg" alt="" class="logo-icon">Synth</a>
            </div>
            <div class="folder-tree" id="folder-tree">
                <!-- Folder tree rendered by JS -->
            </div>
            {% if user %}
            <div class="sidebar-user">
                <span class="user-name">{{ user.display_name }}</span>
                <a href="{{ base_url }}/settings" class="sidebar-settings-btn" title="Settings">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"/>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                    </svg>
                </a>
            </div>
            {% endif %}
        </aside>

        <!-- Main content area -->
        <div class="main-content">
            <main>
                {% block content %}{% endblock %}
            </main>
        </div>
    </div>

    <!-- Sidebar overlay for mobile -->
    <div id="sidebar-overlay" class="sidebar-overlay hidden"></div>

    <!-- Upload modal -->
    <div id="upload-modal" class="modal hidden">
        <div class="modal-content upload-modal-content">
            <span class="close">&times;</span>
            <h2>Upload Media</h2>

            <div class="upload-mode-tabs">
                <button type="button" class="upload-tab active" data-mode="files">Files</button>
                <button type="button" class="upload-tab" data-mode="folder">Folder</button>
            </div>

            <div id="drop-zone" class="drop-zone">
                <input type="file" id="file-input" accept="image/*,video/mp4,video/webm" multiple style="display:none">
                <input type="file" id="folder-input" webkitdirectory multiple style="display:none">
                <div class="drop-zone-text" id="files-drop-text">
                    <span class="drop-icon">+</span>
                    <p>Drag & drop images or videos here</p>
                    <p class="drop-hint">or click to select files (jpg, png, gif, webp, mp4, webm)</p>
                </div>
                <div class="drop-zone-text hidden" id="folder-drop-text">
                    <span class="drop-icon">üìÅ</span>
                    <p>Click to select a folder</p>
                    <p class="drop-hint">Root files ‚Üí photos, subfolders ‚Üí albums</p>
                </div>
            </div>

            <div id="upload-preview-container" class="upload-preview-container hidden">
                <div class="preview-header">
                    <span id="preview-count">0 files selected</span>
                    <button type="button" id="clear-files-btn" class="btn btn-small btn-secondary">Clear</button>
                </div>
                <div id="upload-preview" class="upload-preview"></div>
            </div>

            <div id="upload-options" class="upload-options hidden">
                <div class="upload-option">
                    <label class="checkbox-label">
                        <input type="checkbox" id="upload-as-album">
                        <span class="checkmark"></span>
                        Upload as album
                    </label>
                </div>

                <div class="upload-option">
                    <label class="checkbox-label">
                        <input type="checkbox" id="auto-ai-tags">
                        <span class="checkmark"></span>
                        Auto-generate AI tags
                    </label>
                </div>

                <div id="manual-tags-section" class="manual-tags-section">
                    <label>Add tags:</label>
                    <input type="text" id="upload-tags-input" placeholder="tag1, tag2, tag3..." autocomplete="off">
                    <p class="input-hint">Comma-separated tags to apply to all photos</p>
                </div>
            </div>

            <div id="upload-progress" class="upload-progress hidden">
                <div class="progress-bar"><div id="progress-fill" class="progress-fill"></div></div>
                <span id="progress-text" class="progress-text">Uploading...</span>
            </div>

            <div id="upload-actions" class="upload-actions">
                <button type="button" id="cancel-upload-btn" class="btn btn-secondary">Cancel</button>
                <button type="button" id="submit-upload-btn" class="btn" disabled>Upload</button>
            </div>
        </div>
    </div>

    <!-- Folder modal -->
    <div id="folder-modal" class="modal hidden">
        <div class="modal-content folder-modal-content">
            <span class="close">&times;</span>
            <h2 id="folder-modal-title">Create Folder</h2>

            <div class="form-group">
                <label for="folder-name-input">Folder name:</label>
                <input type="text" id="folder-name-input" placeholder="My Folder" autocomplete="off">
            </div>

            <div class="form-group" id="folder-move-section">
                <label>Location:</label>
                <div id="folder-current-location" style="margin-bottom: 0.5rem; color: var(--text-muted);">Root level</div>
                <button type="button" id="folder-move-btn" class="btn btn-secondary btn-block" style="display: none;">
                    Move to another folder...
                </button>
            </div>

            <div id="default-folder-section" class="form-group hidden">
                <button type="button" id="set-default-folder-btn" class="btn btn-secondary btn-block">
                    Set as default folder
                </button>
            </div>

            <div id="delete-folder-section" class="form-group hidden">
                <button type="button" id="delete-folder-btn" class="btn btn-danger btn-block">
                    Delete folder
                </button>
            </div>

            <div class="modal-actions">
                <button type="button" id="folder-cancel-btn" class="btn btn-secondary">Cancel</button>
                <button type="button" id="folder-submit-btn" class="btn">Create</button>
            </div>
        </div>
    </div>

    <!-- Safe Create modal -->
    <div id="safe-modal" class="modal hidden">
        <div class="modal-content safe-modal-content">
            <span class="close" onclick="closeSafeModal()">&times;</span>
            <h2 id="safe-modal-title">Create Safe</h2>

            <div class="form-group">
                <label for="safe-name-input">Safe name:</label>
                <input type="text" id="safe-name-input" placeholder="My Safe" autocomplete="off">
            </div>

            <div class="form-group">
                <label>Protection method:</label>
                <div class="safe-protection-options">
                    <label class="radio-label">
                        <input type="radio" name="safe-protection" value="password" checked>
                        <span class="radio-text">Password</span>
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="safe-protection" value="webauthn">
                        <span class="radio-text">Hardware Key</span>
                    </label>
                </div>
            </div>

            <form id="safe-form" onsubmit="event.preventDefault();" autocomplete="off">
                <!-- Hidden username field for accessibility and password manager compatibility -->
                <input type="text" id="safe-username" name="username" value="synth-safe-user" autocomplete="username" style="position: absolute; opacity: 0; pointer-events: none;" aria-hidden="true">
                
                <!-- Password protection section -->
                <div id="safe-password-section" class="form-group safe-password-group">
                    <label for="safe-password-input" class="safe-input-label">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                            <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                            <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                        </svg>
                        Create Password
                    </label>
                    <div class="safe-input-wrapper">
                        <input type="password" id="safe-password-input" class="safe-password-input" placeholder="Enter a strong password (min 8 chars)" autocomplete="new-password" minlength="8" required>
                        <button type="button" class="password-toggle" onclick="toggleSafePassword('safe-password-input', this)" aria-label="Show password">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                <circle cx="12" cy="12" r="3"/>
                            </svg>
                        </button>
                    </div>
                    <div class="safe-password-strength" id="safe-password-strength">
                        <div class="strength-bar"></div>
                    </div>
                    <p class="safe-input-hint">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                            <circle cx="12" cy="12" r="10"/>
                            <path d="M12 16v-4M12 8h.01"/>
                        </svg>
                        This password protects your safe. Don't forget it - it cannot be recovered!
                    </p>
                </div>

                <!-- WebAuthn protection section -->
                <div id="safe-webauthn-section" class="form-group hidden">
                    <label class="safe-input-label">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                            <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                        </svg>
                        Select Hardware Key
                    </label>
                    <div class="safe-select-wrapper">
                        <select id="safe-webauthn-select" class="safe-select">
                            <option value="">Loading credentials...</option>
                        </select>
                    </div>
                    <p class="safe-input-hint">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                            <circle cx="12" cy="12" r="10"/>
                            <path d="M12 16v-4M12 8h.01"/>
                        </svg>
                        You'll need this hardware key every time you access the safe
                    </p>
                </div>

                <div class="modal-actions safe-modal-actions">
                    <button type="button" onclick="closeSafeModal()" class="btn btn-secondary safe-cancel-btn">Cancel</button>
                    <button type="submit" id="safe-submit-btn" class="btn safe-submit-btn">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                            <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                        </svg>
                        Create Safe
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Safe Unlock modal -->
    <div id="safe-unlock-modal" class="modal hidden">
        <div class="modal-content safe-modal-content">
            <span class="close" onclick="closeSafeUnlockModal()">&times;</span>
            <h2 id="safe-unlock-title">Unlock Safe</h2>
            <p id="safe-unlock-description" class="modal-description">Enter password to unlock</p>

            <form id="safe-unlock-form" onsubmit="event.preventDefault();" autocomplete="off">
                <!-- Hidden username field for accessibility -->
                <input type="text" id="safe-unlock-username" name="username" value="synth-safe-user" autocomplete="username" style="position: absolute; opacity: 0; pointer-events: none;" aria-hidden="true">
                
                <!-- Password unlock section -->
                <div id="safe-unlock-password-section" class="form-group safe-password-group">
                    <label for="safe-unlock-password-input" class="safe-input-label">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                            <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                            <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                        </svg>
                        Enter Password
                    </label>
                    <div class="safe-input-wrapper">
                        <input type="password" id="safe-unlock-password-input" class="safe-password-input" placeholder="Enter your safe password" autocomplete="current-password" required autofocus>
                        <button type="button" class="password-toggle" onclick="toggleSafePassword('safe-unlock-password-input', this)" aria-label="Show password">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                <circle cx="12" cy="12" r="3"/>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- WebAuthn unlock section -->
                <div id="safe-unlock-webauthn-section" class="form-group hidden">
                    <div class="webauthn-prompt">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="48" height="48">
                            <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                        </svg>
                        <p>Authenticate with your hardware key to unlock</p>
                    </div>
                </div>

                <div class="modal-actions safe-modal-actions">
                    <button type="button" onclick="closeSafeUnlockModal()" class="btn btn-secondary safe-cancel-btn">Cancel</button>
                    <button type="submit" id="safe-unlock-submit-btn" class="btn safe-submit-btn">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                            <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                            <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                            <circle cx="12" cy="12" r="1" fill="currentColor"/>
                        </svg>
                        Unlock
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Safe Edit modal -->
    <div id="safe-edit-modal" class="modal hidden">
        <div class="modal-content folder-modal-content">
            <span class="close" onclick="closeSafeEditModal()">&times;</span>
            <h2 id="safe-edit-modal-title">Edit Safe</h2>

            <div class="form-group">
                <label for="safe-edit-name-input">Safe name:</label>
                <input type="text" id="safe-edit-name-input" placeholder="My Safe" autocomplete="off">
            </div>

            <div id="delete-safe-section" class="form-group">
                <button type="button" id="delete-safe-btn" class="btn btn-danger btn-block">
                    Delete safe
                </button>
            </div>

            <div class="modal-actions">
                <button type="button" onclick="closeSafeEditModal()" class="btn btn-secondary">Cancel</button>
                <button type="button" id="safe-edit-submit-btn" class="btn">Save</button>
            </div>
        </div>
    </div>

    <!-- Include SafeCrypto -->
    <script src="{{ base_url }}/static/js/crypto/safe-crypto.js"></script>

    <!-- Share modal -->
    <div id="share-modal" class="modal hidden">
        <div class="modal-content share-modal-content">
            <span class="close" onclick="closeShareModal()">&times;</span>
            <h2>Share Folder</h2>

            <!-- User search -->
            <div class="share-search">
                <input type="text" id="user-search-input" placeholder="Search users..." autocomplete="off">
                <div id="user-search-results" class="user-search-results hidden"></div>
            </div>

            <!-- Add permission form -->
            <div id="add-permission-form" class="add-permission-form hidden">
                <span id="selected-user-name"></span>
                <select id="permission-level-select">
                    <option value="viewer">Viewer (view only)</option>
                    <option value="editor">Editor (can upload)</option>
                </select>
                <button type="button" id="add-permission-btn" class="btn">Add</button>
                <button type="button" id="cancel-add-btn" class="btn btn-secondary">Cancel</button>
            </div>

            <!-- Current permissions list -->
            <div class="permissions-section">
                <h3>People with access</h3>
                <div id="permissions-list" class="permissions-list">
                    <!-- Dynamically populated -->
                </div>
            </div>

            <div class="modal-actions">
                <button type="button" onclick="closeShareModal()" class="btn">Done</button>
            </div>
        </div>
    </div>

    {% block scripts %}{% endblock %}
</body>
</html>
